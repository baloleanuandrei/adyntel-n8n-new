<context>
# Overview
The Adyntel n8n Custom Node Package is a community integration that enables n8n workflow automation users to access Adyntel's Facebook advertising intelligence API directly within their automation workflows. This package solves the problem of manually retrieving competitive Facebook ads data by providing a seamless, no-code interface for accessing Adyntel's API services. It's valuable for marketers, competitive intelligence analysts, and automation engineers who need to integrate Facebook ads data into their broader automation workflows, data pipelines, or reporting systems.

# Core Features

## Adyntel Facebook API Node
**What it does:** Provides a declarative-style n8n node that fetches Facebook ads data for specified company domains or Facebook page URLs through the Adyntel API.

**Why it's important:** This is the primary integration point that allows users to retrieve competitive Facebook advertising data as part of automated workflows, eliminating manual API calls and reducing technical barriers for non-developers.

**How it works:** The node accepts either a company domain or Facebook page URL as input, along with optional filtering parameters (media type, country, active status, etc.), authenticates using stored credentials (API key, email), and makes POST requests to the `/facebook` endpoint at `api.adyntel.com` to retrieve Facebook ads data. Supports pagination via continuation tokens and webhook delivery for asynchronous processing.

## Adyntel Pics API Node ✅ REMOVED
**Status:** This duplicate node and its associated credentials file have been removed from the codebase as they were part of the original template and not needed for the current implementation. The main Adyntel node handles all required functionality.

## Credential Management
**What it does:** Secure, one-time storage of Adyntel API credentials (API key and email) in n8n's credential system.

**Why it's important:** Ensures secure credential storage following n8n best practices, allowing reuse across multiple nodes and workflows without exposing sensitive information. Users configure credentials once and select them from a dropdown in each node.

**How it works:**
- Implements n8n's ICredentialType interface with encrypted password storage for API keys
- Credentials are stored separately from workflows (secure, reusable)
- Node parameters (company_domain, facebook_url, filters) are configured per-node and support dynamic values from previous nodes
- This separation allows one credential set to query multiple targets dynamically

# User Experience

## User Personas

### Marketing Analyst
- **Need:** Track competitor Facebook ad campaigns automatically
- **Goal:** Integrate competitive intelligence into daily reports
- **Technical Level:** Low to medium; comfortable with no-code tools

### Data Engineer
- **Need:** Build automated data pipelines for ad intelligence
- **Goal:** Feed Facebook ads data into data warehouses or analytics platforms
- **Technical Level:** High; familiar with APIs and automation

### Agency Owner
- **Need:** Monitor multiple client competitors efficiently
- **Goal:** Provide competitive insights as part of service offering
- **Technical Level:** Medium; uses automation tools regularly

## Key User Flows

### Initial Setup Flow
1. Install n8n-nodes-adyntel package via npm
2. Restart or reload n8n to detect the new node
3. **One-time Credential Setup:**
   - Navigate to Credentials in n8n
   - Create new "Adyntel API" credential
   - Enter API Key and Email (these are stored securely and reused)
4. Add Adyntel node to any workflow canvas
5. Select the saved credential from dropdown
6. Node is ready to use

### Typical Workflow Scenario
1. **Trigger/Input:** Webhook receives data OR previous node provides company information
2. **Adyntel Node:**
   - Uses saved credentials (API Key + Email) automatically
   - Accepts `company_domain` dynamically from previous node output (e.g., `{{$json["domain"]}}`)
   - OR accepts `facebook_url` from previous node
   - Optionally add filters: `media_type`, `country_code`, `active_status`
   - Makes API call to Adyntel
3. **Raw Response:** Node outputs complete API response as JSON
4. **Next Nodes:** Downstream nodes access response data using expressions like `{{$json["field_name"]}}`
   - Example: Save to database, send to Google Sheets, trigger notifications, etc.

### Ongoing Usage Flow
1. Open existing workflow with Adyntel node
2. Credentials are already configured (no need to re-enter)
3. Modify node parameters as needed:
   - Change `company_domain` or `facebook_url` (static value or dynamic from previous node)
   - Adjust filtering parameters (media type, country, active status)
   - Add pagination using `continuation_token` from previous response
4. Connect to new downstream nodes if needed
5. Execute workflow - raw API response flows to next nodes

## UI/UX Considerations
- **Separated Credentials:** API Key and Email stored once in n8n Credentials (secure, reusable across workflows)
- **Dynamic Node Parameters:** company_domain and facebook_url accept static values OR dynamic expressions from previous nodes
- **Simple Operation Selection:** Currently single operation ("Get Facebook Ads") with room for expansion
- **Credential Reusability:** Store credentials once, use across multiple nodes and workflows
- **Clear Visual Identity:** Custom Adyntel SVG icon for easy node identification on canvas
- **Standard n8n Patterns:** Follows n8n's declarative routing and parameter conventions for familiarity
- **Raw API Response:** Node outputs unmodified JSON response for maximum flexibility in downstream nodes
- **Expression Support:** All parameters support n8n expressions (e.g., `{{$json["domain"]}}`) for dynamic workflows
- **Error Handling:** Needs clear error messages for API failures, authentication issues, and invalid domains

## Example Workflow

### Scenario: Monitor Competitor Ads from Webhook
```
[Webhook Trigger]
    ↓ (outputs: {"domain": "example.com", "country": "US"})
[Adyntel Node]
    - Credentials: Select "My Adyntel API" (API Key + Email stored)
    - company_domain: {{$json["domain"]}}
    - country_code: {{$json["country"]}}
    - media_type: video
    ↓ (outputs raw API response with ads data)
[Google Sheets Node]
    - Sheet: "Competitor Ads"
    - Data: {{$json["ads"]}} (access fields from Adyntel response)
    ↓
[Slack Node]
    - Message: "Found {{$json["total_ads"]}} new ads for {{$json["company"]}}"
```

**Key Points:**
- Credentials (API Key, Email) are configured once and selected from dropdown
- Node parameters (company_domain, country_code) can be static OR pull from previous node using expressions
- Raw API response flows to next nodes
- Downstream nodes access response fields using `{{$json["field_name"]}}`

</context>

<PRD>
# Technical Architecture

## System Components

### Node Package Structure
- **Package Name:** `n8n-nodes-adyntel`
- **Package Type:** Community node package for n8n
- **Build System:** TypeScript compilation + Gulp for asset management
- **Distribution:** Compiled JavaScript in `/dist` directory

### Core Components
1. **Adyntel.node.ts** - Main node implementation for Facebook ads retrieval
2. **AdyntelApi.credentials.ts** - Credential definition for Adyntel API

**Removed Components (Cleanup Complete):**
- ~~adyntelPics.node.ts~~ - Removed duplicate/template node
- ~~adyntelPicsApi.credentials.ts~~ - Removed unused credentials file

### Build Pipeline
- TypeScript compiler for `.ts` to `.js` conversion
- Gulp tasks for copying SVG icons to dist
- Source maps generation for debugging
- ESLint for code quality and n8n-specific validation

## Data Models

### Credentials Model (AdyntelApi)
```typescript
{
  apiKey: string (password-protected),
  email: string
}
```
Note: company_domain and facebook_url are now node parameters rather than credentials, allowing for more flexible usage across different targets.

### API Request Model
```typescript
POST /facebook
Body: {
  api_key: string (required),
  email: string (required),
  facebook_url?: string (either this or company_domain required),
  company_domain?: string (either this or facebook_url required),
  webhook_url?: string (optional),
  continuation_token?: string (optional),
  media_type?: "image" | "meme" | "image_and_meme" | "video" (optional),
  country_code?: string (optional),
  active_status?: "inactive" | "all" (optional, default: active only)
}
```

### Node Configuration
- **Operation:** "getFacebookAds" (default and only current operation)
- **Node Type:** Transform node (processing/enriching data)
- **Connection Type:** Main input/output for workflow connectivity
- **Credential Binding:** References saved "Adyntel API" credential (API Key + Email)
- **Node Parameters:**
  - company_domain or facebook_url (accepts static values or dynamic expressions from previous nodes)
  - Optional: media_type, country_code, active_status, webhook_url, continuation_token
- **Input:** Can accept data from previous nodes (webhooks, triggers, other nodes)
- **Output:** Returns raw JSON response from Adyntel API for use in subsequent nodes
- **Expression Support:** All parameters support n8n expressions (e.g., `{{$json["company_domain"]}}`)

## APIs and Integrations

### Adyntel API Integration
- **Base URL:** `https://api.adyntel.com`
- **Endpoint:** POST `/facebook`
- **Authentication:** Body-based credentials (api_key, email)
- **Request Format:** JSON
- **Response Format:** JSON
- **Headers:**
  - Accept: application/json
  - Content-Type: application/json
- **Required Parameters:** api_key, email, and either facebook_url OR company_domain
- **Optional Parameters:** webhook_url, continuation_token, media_type, country_code, active_status

### n8n Framework Integration
- **n8n API Version:** 1
- **Node Framework:** Declarative routing pattern
- **Credential Integration:** Generic authentication type
- **Workflow Integration:** Standard Main node connection type

## Infrastructure Requirements

### Development Environment
- **Node.js:** Version 20.15 or higher
- **TypeScript:** Version 5.8.2
- **n8n:** Global installation required for local testing
- **Dependencies:** n8n-workflow (peer dependency)

### Build Dependencies
- eslint + n8n-nodes-base plugin for validation
- Prettier for code formatting
- Gulp for build automation
- Rimraf for clean builds

### Deployment/Distribution
- **Package Registry:** npm (npmjs.com)
- **Installation Method:** `npm install n8n-nodes-adyntel`
- **n8n Integration:** Automatic discovery via package.json n8n configuration
- **Optional:** n8n cloud verification for community node directory

# Development Roadmap

## Phase 1: MVP - Core Facebook Ads Functionality ✓ (Mostly Complete)
- [x] Basic n8n node structure and TypeScript setup
- [x] AdyntelApi credential definition with API key and email
- [x] Adyntel node with "Get Facebook Ads" operation
- [x] Declarative routing to POST /facebook endpoint
- [x] Build pipeline (TypeScript + Gulp)
- [x] Basic package.json configuration
- [ ] Update credentials to remove company_domain (move to node parameter)
- [ ] Complete documentation (README update)
- [ ] Error handling and validation
- [ ] Testing infrastructure

## Phase 2: Enhanced Functionality
- [x] ~~Complete adyntelPics node implementation~~ (Removed - not needed)
- [ ] Add dynamic parameter inputs (company_domain and facebook_url as node parameters with expression support)
- [ ] Support for all API parameters with n8n expression capability:
  - **facebook_url** (string): Facebook page URL (must start with https://) - Either this or company_domain required
  - **company_domain** (string): Company website - Either this or facebook_url required
  - **webhook_url** (string): Webhook URL where data will be returned (optional)
  - **continuation_token** (string): Token to grab the next set of ads for pagination (optional)
  - **media_type** (string): Filter by media type - Possible values: image, meme, image_and_meme, video (optional)
  - **country_code** (string): Filter by specific country (optional)
  - **active_status** (string): Filter by ad status - Possible values: inactive, all (default: active only) (optional)
- [ ] Raw API response output (pass-through without transformation for downstream node flexibility)
- [ ] Pagination handling using continuation_token
- [ ] Rate limiting and retry logic
- [ ] Comprehensive error messages
- [ ] Input validation for required parameters and URL formats
- [ ] Support for n8n expressions in all parameter fields (enable dynamic values from previous nodes)

## Phase 3: Production Ready
- [ ] Comprehensive unit and integration tests
- [ ] E2E testing with actual n8n workflows
- [ ] Complete API documentation
- [ ] User guide with workflow examples
- [ ] Performance optimization
- [ ] Security audit
- [ ] npm publication
- [ ] n8n community node submission

# Logical Dependency Chain

## Foundation Layer (Must Build First)
1. **Credential System** - Without secure credential storage, nodes cannot authenticate
2. **Build Infrastructure** - TypeScript compilation and asset management must work before node development
3. **Basic Node Structure** - Core Adyntel node with minimal functionality to validate architecture

## Visible/Usable Milestone 1
4. **Working "Get Facebook Ads" Operation** - First tangible functionality that users can test
5. **Local Testing Setup** - Ability to link and test node in local n8n instance
6. **Basic Documentation** - README with installation and usage instructions

## Incremental Enhancement Layer
7. **Error Handling** - Make the basic operation robust before adding more features
8. **Dynamic Parameters** - Support for facebook_url and company_domain as node parameters
9. ~~**AdyntelPics Node**~~ - Removed as part of cleanup (was duplicate/template code)

## Enhanced Parameter Support Layer
10. **All API Parameters** - Support for media_type, country_code, active_status, webhook_url, continuation_token with expression support
11. **Raw Response Output** - Pass-through API response without transformation for maximum downstream flexibility
12. **Expression Support** - Enable n8n expressions in all parameters for dynamic workflows (e.g., pulling company_domain from previous node)
13. **Performance Optimization** - Rate limiting, retry logic, pagination handling

## Production Readiness Layer
14. **Testing Suite** - Comprehensive tests before public release
15. **Complete Documentation** - User guides, API docs, workflow examples
16. **npm Publication** - Make available to community

# Risks and Mitigations

## Technical Challenges

**Risk:** Adyntel API changes or rate limiting could break the integration
- **Mitigation:** Implement version detection, graceful degradation, and configurable retry logic with exponential backoff

**Risk:** n8n framework updates may introduce breaking changes
- **Mitigation:** Pin peer dependency versions, maintain compatibility matrix, regular testing against n8n updates

**Risk:** Credential security vulnerabilities
- **Mitigation:** Follow n8n security best practices, use password-type fields, never log credentials, security audit before publication

**Risk:** Large API responses could cause memory issues in workflows
- **Mitigation:** Implement pagination, streaming responses, configurable result limits, and chunking for large datasets

## MVP Definition Challenges

**Risk:** Scope creep - trying to support all possible Adyntel API features at once
- **Mitigation:** MVP = Single working operation ("Get Facebook Ads") with basic error handling and documentation. Everything else is post-MVP.

**Risk:** Over-engineering the credential system before understanding actual usage patterns
- **Mitigation:** Start with simple credential model (API key + email + domain). Refactor to more sophisticated auth only if needed.



## Resource Constraints

**Risk:** Limited knowledge of Adyntel API capabilities and response formats
- **Mitigation:** Test extensively with real API, document response schemas, build flexible data handling

**Risk:** Maintaining compatibility with both local n8n and n8n cloud
- **Mitigation:** Follow n8n community node guidelines strictly, test in both environments before publication

**Risk:** Time investment in testing and documentation
- **Mitigation:** Automate testing where possible, create documentation templates, leverage n8n community examples

## Distribution and Adoption

**Risk:** Package not discoverable or installable
- **Mitigation:** Follow npm and n8n publication checklists, test installation process, provide clear installation docs

**Risk:** Users encounter setup difficulties
- **Mitigation:** Provide step-by-step setup guide, video walkthrough, example workflows, troubleshooting section

**Risk:** Breaking changes in updates affect existing users
- **Mitigation:** Semantic versioning, changelog, migration guides, deprecation warnings

# Appendix

## Current Implementation Status
- **Adyntel Node:** Basic structure complete, single operation implemented
- **Build System:** Functional with TypeScript + Gulp
- **Package Configuration:** Basic setup complete, needs refinement for publication
- **Documentation:** Starter README present, needs replacement with actual documentation
- **Testing:** No test infrastructure currently

## Recent Changes (2025-10-13)
- ✅ Removed adyntelPicsApi.credentials.ts file
- ✅ Removed adyntelPics node directory and all associated files
- ✅ Cleaned up codebase from duplicate/template artifacts
- ✅ Project now has single, focused Adyntel node implementation

## Development Workflow & Version Control

This project uses **git-flow-next** as the branching strategy to maintain clean, organized development.

### Branch Strategy
- **master** - Production-ready code, stable releases only
- **develop** - Integration branch for ongoing development
- **feature/** - Individual feature branches for new functionality
- **bugfix/** - Bug fix branches
- **release/** - Release preparation branches
- **hotfix/** - Emergency fixes for production issues

### Feature Development Workflow

**IMPORTANT:** Each feature, enhancement, or significant change MUST be developed in its own separate branch.

#### Standard Feature Development Process:
1. **Start from develop branch:**
   ```
   git checkout develop
   git pull origin develop
   ```

2. **Create a feature branch:**
   ```
   git checkout -b feature/descriptive-feature-name
   ```
   Examples:
   - `feature/add-error-handling`
   - `feature/implement-pagination`
   - `feature/adyntel-pics-node`
   - `feature/dynamic-company-domain`

3. **Develop and commit in the feature branch:**
   - Make incremental commits with clear messages
   - Keep the feature focused and atomic
   - Test thoroughly before merging

4. **Merge back to develop when complete:**
   ```
   git checkout develop
   git merge feature/descriptive-feature-name
   ```

5. **Delete the feature branch after merge:**
   ```
   git branch -d feature/descriptive-feature-name
   ```

### Why Separate Branches?

1. **Isolation:** Each feature develops independently without affecting other work
2. **Code Review:** Easier to review changes when they're focused on a single feature
3. **Rollback:** If a feature breaks something, it's easy to identify and revert
4. **Parallel Development:** Multiple features can be worked on simultaneously
5. **Clean History:** Git history remains organized and understandable
6. **Testing:** Features can be tested individually before integration

### Branch Naming Conventions

- `feature/` - New features or enhancements
- `bugfix/` - Bug fixes for develop branch
- `hotfix/` - Emergency fixes for production (branch from master)
- `release/` - Preparing a new production release
- `docs/` - Documentation-only changes
- `refactor/` - Code refactoring without changing functionality
- `test/` - Adding or updating tests

### Example Workflow for This Project

For implementing error handling from the roadmap:
```bash
# Start feature
git checkout develop
git checkout -b feature/add-error-handling

# Work on the feature
# ... make changes to Adyntel.node.ts ...
git add nodes/Adyntel/Adyntel.node.ts
git commit -m "Add error handling for API failures"

# ... add validation ...
git add nodes/Adyntel/Adyntel.node.ts
git commit -m "Add input validation for company domain"

# Complete feature
git checkout develop
git merge feature/add-error-handling
git branch -d feature/add-error-handling
```

### Rules of Engagement

✅ **DO:**
- Create a new branch for every feature, no matter how small
- Keep branches short-lived (merge within days, not weeks)
- Write descriptive branch names
- Commit frequently with clear messages
- Test before merging to develop
- Delete branches after merging

❌ **DON'T:**
- Work directly on master or develop branches
- Mix multiple unrelated features in one branch
- Let feature branches diverge too far from develop
- Force push to shared branches
- Merge untested code

## Technical Specifications

### n8n Node Configuration
```json
{
  "n8nNodesApiVersion": 1,
  "credentials": [
    "dist/credentials/AdyntelApi.credentials.js"
  ],
  "nodes": [
    "dist/nodes/Adyntel/Adyntel.node.js"
  ]
}
```

### File Structure
```
/credentials
  - AdyntelApi.credentials.ts (API credentials)
/nodes
  /Adyntel
    - Adyntel.node.ts (Main node implementation)
    - Adyntel.node.json (Node metadata)
    - adyntel.svg (Node icon)
/dist (Build output)
```

**Removed Files (Cleanup Complete):**
```
/credentials
  - adyntelPicsApi.credentials.ts ✅ REMOVED
/nodes
  /adyntelPics ✅ REMOVED
    - adyntelPics.node.ts
    - adyntelpics.node.json
    - adyntelpics.svg
```

### Dependencies Analysis
- **Peer Dependencies:** n8n-workflow (user's n8n installation)
- **Dev Dependencies:** TypeScript, ESLint, Gulp, Prettier, n8n linting plugin
- **Runtime Dependencies:** task-master-ai (potentially for project management)

## Research Findings

### n8n Community Node Best Practices
1. Use declarative routing for simple API calls
2. Implement proper credential encryption
3. Provide clear operation descriptions
4. Follow n8n naming conventions
5. Include comprehensive error handling
6. Supply example workflows
7. Test with various n8n versions

### Adyntel API Integration Considerations
- API requires authentication via api_key and email in request body
- Either facebook_url or company_domain must be provided (mutually exclusive alternatives)
- POST method for Facebook endpoint supports rich filtering and pagination options
- Base URL suggests potential for multiple service endpoints
- Support for webhook delivery enables asynchronous processing of large datasets
- Pagination via continuation_token allows handling of large result sets
- Multiple filter parameters (media_type, country_code, active_status) provide flexible querying

### Gap Analysis
1. **Missing:** Response data schema documentation
2. **Missing:** Error response handling
3. **Missing:** Pagination support using continuation_token
4. **Missing:** Input validation for URL formats (facebook_url) and domain formats
5. **Missing:** Support for all optional parameters (webhook_url, media_type, country_code, active_status)
6. **Missing:** Rate limiting handling
7. ~~**Incomplete:** adyntelPics node functionality~~ ✅ RESOLVED (removed from codebase)
8. **Incomplete:** User documentation
9. **Incomplete:** Testing infrastructure

## Next Immediate Actions
1. Update credentials file to remove company_domain (keep only API Key + Email)
2. Implement support for facebook_url and company_domain as node parameters with n8n expression support
3. Add support for all optional parameters (webhook_url, continuation_token, media_type, country_code, active_status)
4. Ensure raw API response is passed through without transformation
5. Complete basic error handling for Adyntel node
6. Test actual API responses and document schema
7. Implement input validation for URL formats (facebook_url must start with https://)
8. Test dynamic parameter expressions with sample workflow (webhook → Adyntel → next node)
9. Create comprehensive README with setup and usage instructions
10. Implement basic unit tests
11. Test installation process in clean n8n environment
12. ~~Decide on adyntelPics node priority and implementation timeline~~ ✅ RESOLVED (removed from scope)
</PRD>

