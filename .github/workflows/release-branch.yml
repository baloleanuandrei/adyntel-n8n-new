name: Release Branch CI

on:
  push:
    branches:
      - 'release/**'

jobs:
  test:
    name: Test & Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Run tests
        run: npm test

      - name: Build
        run: npm run build

      - name: Run security audit
        run: npm audit --audit-level=high

  validate-release:
    name: Validate Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check release branch naming
        run: |
          BRANCH_NAME="${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}"
          echo "Branch name: $BRANCH_NAME"

          # Validate release branch naming
          if [[ "$BRANCH_NAME" =~ ^release/[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âœ“ Valid release branch name with semantic version"
          else
            echo "âš  Warning: Release branch should follow pattern 'release/X.Y.Z'"
          fi

      - name: Check version consistency
        run: |
          # Extract version from branch name
          BRANCH_NAME="${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}"
          BRANCH_VERSION=$(echo "$BRANCH_NAME" | sed 's/release\///')

          # Check package.json version
          PACKAGE_VERSION=$(node -p "require('./package.json').version")

          echo "Branch version: $BRANCH_VERSION"
          echo "Package.json version: $PACKAGE_VERSION"

          if [ "$BRANCH_VERSION" = "$PACKAGE_VERSION" ]; then
            echo "âœ“ Version consistency check passed"
          else
            echo "âš  Warning: Branch version ($BRANCH_VERSION) doesn't match package.json ($PACKAGE_VERSION)"
            echo "Run: npm version $BRANCH_VERSION --no-git-tag-version"
          fi

  check-changelog:
    name: Check Changelog
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify CHANGELOG.md exists
        run: |
          if [ -f "CHANGELOG.md" ]; then
            echo "âœ“ CHANGELOG.md exists"

            BRANCH_NAME="${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}"
            VERSION=$(echo "$BRANCH_NAME" | sed 's/release\///')

            # Check if version is mentioned in changelog
            if grep -q "$VERSION" CHANGELOG.md; then
              echo "âœ“ Version $VERSION found in CHANGELOG.md"
            else
              echo "âš  Warning: Version $VERSION not found in CHANGELOG.md"
              echo "Please update CHANGELOG.md with release notes"
            fi
          else
            echo "âš  Warning: CHANGELOG.md not found"
            echo "Consider creating a CHANGELOG.md file"
          fi

  notify-release:
    name: Notify Release Preparation
    runs-on: ubuntu-latest
    needs: [test, validate-release]

    steps:
      - name: Notify team
        run: |
          BRANCH_NAME="${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}"
          VERSION=$(echo "$BRANCH_NAME" | sed 's/release\///')
          echo "ðŸ“¦ Release $VERSION preparation in progress"
          echo "Checklist:"
          echo "  - [ ] Version bumped in package.json"
          echo "  - [ ] CHANGELOG.md updated"
          echo "  - [ ] Documentation updated"
          echo "  - [ ] All tests passing"
          echo "  - [ ] Ready for final review"
          # Add notifications here (Slack, Discord, etc.)
