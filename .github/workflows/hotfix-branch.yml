name: Hotfix Branch CI

on:
  push:
    branches:
      - 'hotfix/**'

jobs:
  test:
    name: Fast Test & Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Run tests
        run: npm test

      - name: Build
        run: npm run build

      - name: Run security audit
        run: npm audit --audit-level=critical

  validate-hotfix:
    name: Validate Hotfix Branch
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check branch naming and base
        run: |
          BRANCH_NAME="${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}"
          echo "Branch name: $BRANCH_NAME"

          # Validate hotfix branch naming
          if [[ "$BRANCH_NAME" =~ ^hotfix/[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âœ“ Valid hotfix branch name with version"
          else
            echo "âš  Warning: Hotfix branch should follow pattern 'hotfix/X.Y.Z'"
          fi

          # Check if based on main
          MERGE_BASE=$(git merge-base HEAD origin/main)
          MAIN_HEAD=$(git rev-parse origin/main)

          if [ "$MERGE_BASE" = "$MAIN_HEAD" ]; then
            echo "âœ“ Hotfix branch is based on main"
          else
            echo "âš  Warning: Hotfix should be based on main branch"
          fi

  notify-hotfix:
    name: Notify Hotfix Creation
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Notify team
        run: |
          BRANCH_NAME="${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}"
          echo "ðŸš¨ Hotfix branch created: $BRANCH_NAME"
          echo "This indicates a critical production issue is being addressed"
          # Add notifications to alert team members
          # Examples: Slack, Discord, PagerDuty, email
